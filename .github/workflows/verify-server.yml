name: Verify Flask Server

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify EC2 instance is running
        shell: bash
        run: |
          set -euo pipefail

          echo "Checking EC2 instance ${{ vars.EC2_INSTANCE_ID }}..."
          STATE="$(aws ec2 describe-instances \
            --instance-ids "${{ vars.EC2_INSTANCE_ID }}" \
            --query "Reservations[0].Instances[0].State.Name" \
            --output text)"

          echo "Instance state: $STATE"

          if [[ "$STATE" != "running" ]]; then
            echo "EC2 instance is not running (state: $STATE)"
            exit 1
          fi

          echo "EC2 instance is running ✅"

      - name: Verify Flask API is responding (port 80)
        shell: bash
        run: |
          set -euo pipefail

          IP="${{ vars.EC2_PUBLIC_IP }}"
          URL="http://${IP}/health"

          echo "Requesting: $URL"

          # Get HTTP status + save body
          HTTP_CODE="$(curl -sS -o /tmp/health.json -w "%{http_code}" "$URL" --max-time 10 || true)"
          echo "HTTP code: $HTTP_CODE"
          echo "Body:"
          cat /tmp/health.json || true

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "Health endpoint did not return 200"
            exit 1
          fi

          HEALTH_JSON="$(cat /tmp/health.json || true)"

          # Verify JSON response contains required fields (simple grep checks)
          echo "$HEALTH_JSON" | grep -q "\"status\"" || (echo "Missing 'status' field" && exit 1)
          echo "$HEALTH_JSON" | grep -q "\"timestamp\"" || (echo "Missing 'timestamp' field" && exit 1)
          echo "$HEALTH_JSON" | grep -q "\"hostname\"" || (echo "Missing 'hostname' field" && exit 1)

          echo "Flask API responding with required fields ✅"

      - name: Summary
        shell: bash
        run: |
          echo "========================================"
          echo "All checks passed!"
          echo "========================================"
